<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="scripts\hmac-sha1.js"></script>
  </head>
  
  <body>
    <div class="container">
      
        <div class="today">
          <div class="city t_item"></div>        
          <div class="today_con">
            <div class="today_icon t_item"></div>
            <div class="today_tem">
              <span class="tem_num t_item"></span>
              <span class="tem_icon">o</span>
            </div>          
          </div>
          <div class="today_text t_item"></div>
        </div>
      

      <div class="detail">
        <div class="car">
          洗车：
          <span class="d_item "></span>
        </div>
        <div class="dress">
          穿衣：
          <span class="d_item "></span>
        </div>
        <div class="flu">
          感冒：
          <span class="d_item "></span>
        </div>
        <div class="sport">
          运动：
          <span class="d_item "></span>
        </div>
        <div class="travel">
          旅游：
          <span class="d_item "></span>
        </div>
        <div class="uv">
          紫外线强度：
          <span class="d_item "></span>
        </div>
      </div>

      <div class="future">
        <div class="future_con">
          <div class="f_item day_one">
            <div class="date day1_item"></div>
            <div class="d_icon day1_item icon"></div>
            <div class="wea_tem">
              <span class="tem_high day1_item"></span>
              <span class="tem_low day1_item"></span>
            </div>
            <div class="d_text day1_item"></div>
            <div class="n_icon day1_item icon"></div>
            <div class="n_text day1_item"></div>
          </div>
          <div class="f_item day_two">
            <div class="date day2_item"></div>
            <div class="d_icon day2_item icon"></div>
            <div class="wea_tem">
              <span class="tem_high day2_item"></span>
              <span class="tem_low day2_item"></span>
            </div>
            <div class="d_text day2_item"></div>
            <div class="n_icon day2_item icon"></div>
            <div class="n_text day2_item"></div>
          </div>
          <div class="f_item day_three">
            <div class="date day3_item"></div>
            <div class="d_icon day3_item icon"></div>
            <div class="wea_tem">
              <span class="tem_high day3_item"></span>
              <span class="tem_low day3_item"></span>
            </div>
            <div class="d_text day3_item"></div>
            <div class="n_icon day3_item icon"></div>
            <div class="n_text day3_item"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      var AK = "1tgj5I8qaiFEh5BGgbXHf41CpexY4EoB";
      var KEY = "dfzdhlqmyfa92cek";
      var UID = "UC47E98595";
      var API = "https://api.seniverse.com/v3";

      var nowApi = API + "/weather/now.json";
      var dailyApi = API + "/weather/daily.json";
      var lifeSugApi = API + "/life/suggestion.json";
      var searchApi = API + "/location/search.json";
      
      getCity(AK);

      function getCity(ak) {
        var baiduUrl = 'http://api.map.baidu.com/location/ip?ak=' + ak + '&coor=bd09ll&callback=baiduCallback';
        createScript(baiduUrl);
      }

      function baiduCallback(data) {
        var oCity = data.content.address_detail.city.replace("市", "");
        console.log('baiduCity:'+oCity);
        setUrl(oCity);
      }

      function setUrlStr() {
        var ts = Math.floor((new Date()).getTime() / 1000);
        var str = "ts=" + ts + "&uid=" + UID;
        var sig = CryptoJS.HmacSHA1(str, KEY).toString(CryptoJS.enc.Base64);

        sig = encodeURIComponent(sig);
        return str = str + "&sig=" + sig;
      }

      function setUrl(city) {
        var str = setUrlStr();
        console.log(str);
        var nowUrl = nowApi + "?location=" + city + "&" + str + "&callback=nowCallback";
        var dailyUrl = dailyApi + "?location=" + city + "&" + str + "&callback=dailyCallback";
        var lifeSugUrl = lifeSugApi + "?location=" + city + "&" + str + "&callback=lifeSugCallback";
        var searchUrl = searchApi + "?" + str + "&q=" + city + "&callback=searchCallback";
        console.log('cityInUrl: '+city);

        createScript(nowUrl);
        createScript(dailyUrl);
        createScript(lifeSugUrl);
        createScript(searchUrl);
      }

      function createScript(url) {
        var newScript = document.createElement("script");
        newScript.type = "text/javascript";
        newScript.src = url;
        document.body.append(newScript);
      }

      function nowCallback(data) {
        var tItems = document.querySelectorAll(".t_item");
        var weather = data.results[0];
        tItems[0].innerText = weather.location.name;
        tItems[1].style.background = 'url(img/180/' + weather.now.code + '.png)  center center';
        tItems[2].innerText = weather.now.temperature;
        tItems[3].innerText = weather.now.text;
      }

      function dailyCallback(data)  {
        var day1Items = document.querySelectorAll(".day1_item");
        var wDaily = data.results[0].daily;
        day1Items[0].innerText = wDaily[0].date;
        day1Items[1].innerHTML = '<img src="img/180/' + wDaily[0].code_day + '.png">';  
        day1Items[2].innerText = wDaily[0].high + "℃";
        day1Items[3].innerText = wDaily[0].low + "℃";
        day1Items[4].innerText = wDaily[0].text_day;
        day1Items[5].innerHTML = '<img src="img/180/' + wDaily[0].code_night + '.png">';
        day1Items[6].innerText = wDaily[0].text_night;

        var day2Items = document.querySelectorAll(".day2_item");
        day2Items[0].innerText = wDaily[1].date;
        day2Items[1].innerHTML = '<img src="img/180/' + wDaily[1].code_day + '.png">';  
        day2Items[2].innerText = wDaily[1].high + "℃";
        day2Items[3].innerText = wDaily[1].low + "℃";
        day2Items[4].innerText = wDaily[1].text_day;
        day2Items[5].innerHTML = '<img src="img/180/' + wDaily[1].code_night + '.png">';
        day2Items[6].innerText = wDaily[1].text_night;

        var day3Items = document.querySelectorAll(".day3_item");
        day3Items[0].innerText = wDaily[2].date;
        day3Items[1].innerHTML = '<img src="img/180/' + wDaily[2].code_day + '.png">';  
        day3Items[2].innerText = wDaily[2].high + "℃";
        day3Items[3].innerText = wDaily[2].low + "℃";
        day3Items[4].innerText = wDaily[2].text_day;
        day3Items[5].innerHTML = '<img src="img/180/' + wDaily[2].code_night + '.png">';
        day3Items[6].innerText = wDaily[2].text_night;
      }      

      function lifeSugCallback(data) {
        var sug = data.results[0].suggestion;
        var dItems = document.querySelectorAll(".d_item");
        dItems[0].innerText = sug.car_washing.brief;
        dItems[1].innerText = sug.dressing.brief;
        dItems[2].innerText = sug.flu.brief;
        dItems[3].innerText = sug.sport.brief;
        dItems[4].innerText = sug.travel.brief;
        dItems[5].innerText = sug.uv.brief;
      }

      function searchCallback(data) {
        console.log('searchCity: ' + data.results[0].name);
      }


    </script>
  </body>
</html>
